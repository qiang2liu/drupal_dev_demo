<?php

function themuraly_menu() {
  
  $items['mural/create'] = array(
     'page callback' => 'muralcreate',
     'access callback' => 'user_is_logged_in',
     'type' => MENU_CALLBACK,
     'file' => 'mural_op.inc',
  );
  $items['mural/create/%'] = array(
    'page callback' => 'muralcreate',
    'page arguments' => array(2),
     'access callback' => 'user_is_logged_in',
     'type' => MENU_CALLBACK,
     'file' => 'mural_op.inc',
  );
  $items['mural/%'] = array(
    'page callback' => 'muralshow',
    'page arguments' => array(1),
     'access callback' => 'user_is_logged_in',
     'type' => MENU_CALLBACK,
     'file' => 'mural_op.inc',
  );
  
  $items['muraltest'] = array(
      'page callback' => 'muralapi_test',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  return $items;
}

function themuraly_theme($existing, $type) {
  return array(
        'muralypage' => array(
            'variables' => array('data' => NULL),
            'template' => 'templates/muralypage',
        ),
       
    );
}
function muralapi_create_room($mural_api, $muralusername, $title, $account) {
  $mural_api_result = $mural_api->create_room($muralusername,$title);
  if (is_object($mural_api_result) && isset($mural_api_result->data)) {
    $muralapi_response_obj = drupal_json_decode($mural_api_result->data);
   if ( !empty($muralapi_response_obj['id'])){
       $edit['field_muralroomid'][LANGUAGE_NONE][0]['value'] = $muralapi_response_obj['id'];
       user_save($account, $edit);
       return $muralapi_response_obj['id'];
   }
  }
  return '';
}
function muralapi_test() {
 _test_mural_list_for_a_user();
 // _test_user_add();
  //_test_create_room();
 // _test_mural_create_mural();
  
  //_test_mural_duplicate_mural();
   //_test_mural_update_property_mural();
   //_test_mural_archive();
   //_test_mural_del();
   //_test_mural_list_for_a_user();
   $output_html = "<iframe frameborder='0' src='http://staging.mural.ly/embed/edgemakers/edgemakers/1374110398829' width=500px height=500px'></iframe>";
   //$output_html = "<iframe frameborder='0' src='http://staging.mural.ly/embed/edgemakers/edgemakers/1374641493558' width=500px height=500px'></iframe>";
   
   
  return $output_html;
}
function _test_mural_del() {
   $mural_api = new Muralapi;
  $username = "testuser";
  $muralid = "1374197201377";
  $result = $mural_api->delete_mural($username,$muralid);
  $data = $result->data;  //it is a string
  //$r = drupal_json_decode($data);
  dpm($result);
  dpm($data);
}
function _test_create_room() {
  $mural_api = new Muralapi;
  $username = "testuser";
  $title = 'mymuralroom';
  $result = $mural_api->create_room($username,$title);
  $data = $result->data;
  $r = drupal_json_decode($data);
  dpm($result);
  dpm($r);

}
function _test_mural_archive() {
  $mural_api = new Muralapi;
  $username = "testuser";
  $muralid = "1374197201377";
  $archive_flag = 1;
  $result = $mural_api->archive_mural($username,$muralid, $archive_flag);
  $data = $result->data;
  //$r = drupal_json_decode($data);
  dpm($result);
  dpm($data);
  
}

function _test_mural_update_property_mural() {
  $mural_api = new Muralapi;
  $username = "testuser";
  $muralid = "1374197201377";
  $property_name = "xxt";
  $property_value = "test change description value";
  $result = $mural_api->update_mural_properties($username, $muralid, $property_name, $property_value);
  $data = $result->data;
  $r = drupal_json_decode($data);
  dpm($result);
  dpm($r);
}

function _test_mural_duplicate_mural() {
  $mural_api = new Muralapi;
  $params = array('title'=>'this is a duplicate from a mural','room'=> 1373060830214,);
  $result = $mural_api->duplicate_mural('testuser', '1373655313624' ,$params);
  $data = $result->data;
  $r = drupal_json_decode($data);
  dpm($result);
  dpm($r);
}

function _test_mural_create_mural() {
  $mural_api = new Muralapi;
  $str = rand(800,10000);
  $params = array('title'=>$str .' this is a mural','room'=> 1373060830214,);
  $result = $mural_api->create_mural('testuser', $params);
  $data = $result->data;
  $r = drupal_json_decode($data);
  dpm($result);
  dpm($r);
}

function _test_mural_list_for_a_user() {
  $mural_api = new Muralapi;
  $result = $mural_api->get_all_murals('kk2t');
  $data = $result->data;
  $r = drupal_json_decode($data);
  dpm($result);
  dpm($r);
}

function _test_user_add() {

  $mural_api = new Muralapi;
  $str = rand(800,10000);
  $user = array();
  $user['username'] = "test" . $str;
  $user['username'] = "ppt777";
  $user['email'] = "ppt" . $str . "@symbio.com";
  $user['source'] = "edgemakers";
  $user['nameIdentifier'] = 3;

  $mural_api_result = $mural_api->create_user($user, '/api/organizations/edgemakers/users', 'POST');
  dpm($mural_api_result);
  //dd($mural_api_result);
  $muralapi_response_obj = drupal_json_decode($mural_api_result->data);
  dpm($muralapi_response_obj);

  if (isset($muralapi_response_obj['hasErrors'])) {
    if (!$muralapi_response_obj['hasErrors']) {
      // successful, then 
      $edit = array();
      // the $muralapi_response_obj will contain the user attribute ($muralapi_response_obj->user)
      // but now ,it has no this attribute, so , just reguard the $account->name as the  mural username
      $the_mural_username = "";
      if (isset($muralapi_response_obj['user'])) {
        if (isset($muralapi_response_obj['user']['username'])) {
          $the_mural_username = $muralapi_response_obj['user']['username'];
        }
      }


      $edit['field_muralusername'][LANGUAGE_NONE][0]['value'] = $the_mural_username;
      // user_save($account, $edit);
      dpm($edit);
    }
  }
}
